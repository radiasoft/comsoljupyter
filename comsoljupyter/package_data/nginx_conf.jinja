daemon off;
pid /tmp/nginx_comsol.pid;

events {
    worker_connections 768;
}

http {
    error_log /tmp/comsol_nginx.error.log;
    access_log /tmp/comsol_nginx.access.log;


    {% for s in sessions %}
    server {

        listen {{ s.port }};

        if ($cookie_RSESSIONID != "{{ s.rsessionid }}") {
            return 401;
        }

        location / {
            proxy_pass https://comsol.radiasoft.org;
            proxy_set_header Cookie "CSSESSIONID={{ s.cssessionid }}; JSESSIONID={{ s.jsessionid }}; ${http_cookie}";
        }

        location /ui-ws {
            proxy_http_version 1.1;
            proxy_pass https://comsol.radiasoft.org;
            proxy_set_header Connection "upgrade";
            proxy_set_header Cookie "CSSESSIONID={{ s.cssessionid }}; JSESSIONID={{ s.jsessionid }}; ${http_cookie}";
            proxy_set_header Upgrade $http_upgrade;
        }

    }
    {% endfor %}
}
